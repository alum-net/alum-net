name: Deploy to prod

on:
  push:
    branches:
      - main
  workflow_dispatch:
  
permissions:
  contents: write
  
jobs:
  deploy:
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------------
      # 1) Checkout de código
      # --------------------------------------------------------------
      - name: Checkout deploy-test
        uses: actions/checkout@v4
        with:
          ref: deploy-test
          fetch-depth: 0

      # --------------------------------------------------------------
      # 2) Merge LOCAL de main → deploy-test 
      # --------------------------------------------------------------
      - name: Merge main into deploy-test and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          echo "[FETCHING LATEST]"
          git fetch origin
          
          echo "[MERGING MAIN → DEPLOY-TEST]"
          git merge origin/main --no-edit
          
          echo "[PUSHING TO REMOTE]"
          git push origin deploy-test
          
          echo "[MERGE & PUSH DONE]"
          git log --oneline -5

      # --------------------------------------------------------------
      # 3) Verificar herramientas 
      # --------------------------------------------------------------
      - name: Check environment
        run: |
          echo "Docker version:"
          docker --version
          echo "AWS CLI version:"
          aws --version

      # --------------------------------------------------------------
      # 4) Login a AWS ECR
      # --------------------------------------------------------------
      - name: AWS ECR Login
        run: |
          aws ecr get-login-password --region us-east-1 | \
          docker login \
            --username AWS \
            --password-stdin 205292723184.dkr.ecr.us-east-1.amazonaws.com
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # --------------------------------------------------------------
      # 5) Build & push FRONTEND
      # --------------------------------------------------------------
      - name: Generate .env for frontend
        run: |
          cd frontend
          echo "${{ secrets.FRONTEND_ENV_FILE }}" > .env
          echo "[INFO] .env generated"
      
      - name: Build frontend image
        run: |
          cd frontend
          docker build -t alumnet-frontend -f Dockerfile.web .

      - name: Push frontend
        run: |
          docker tag alumnet-frontend:latest \
            205292723184.dkr.ecr.us-east-1.amazonaws.com/alumnet-frontend:latest
          docker push \
            205292723184.dkr.ecr.us-east-1.amazonaws.com/alumnet-frontend:latest

      # --------------------------------------------------------------
      # 6) Build & push BACKEND
      # --------------------------------------------------------------
      - name: List backend folder contents
        run: |
          echo "[BACKEND DIRECTORY CONTENTS]"
          ls -R backend
      
      - name: Build backend image
        run: |
          docker build \
            -t alumnet-backend \
            -f backend/Dockerfile \
            ./backend

      - name: Push backend
        run: |
          docker tag alumnet-backend:latest \
            205292723184.dkr.ecr.us-east-1.amazonaws.com/alumnet-backend:latest
          docker push \
            205292723184.dkr.ecr.us-east-1.amazonaws.com/alumnet-backend:latest

      # --------------------------------------------------------------
      # 7) Copiar clave SSH para conexión a EC2
      # --------------------------------------------------------------
      - name: Add SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      # --------------------------------------------------------------
      # 8) Ejecutar comandos remotos en EC2
      # --------------------------------------------------------------
      - name: Connect & deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          
          echo "[STOPPING OLD CONTAINERS]"
          docker stop keycloak_server || true
          docker stop alumnet_nginx || true
          docker stop mongo_db || true
          docker stop postgres_db || true
          docker stop alumnet_frontend || true
          docker stop backend || true
          docker stop keycloak_db || true

          docker system prune -f

          echo "[ECR LOGIN]"
          aws ecr get-login-password --region us-east-1 | \
          docker login \
            --username AWS \
            --password-stdin 205292723184.dkr.ecr.us-east-1.amazonaws.com

          echo "[PULL IMAGES]"
          docker pull 205292723184.dkr.ecr.us-east-1.amazonaws.com/alumnet-frontend:latest
          docker pull 205292723184.dkr.ecr.us-east-1.amazonaws.com/alumnet-backend:latest

          echo "[START WITH DOCKER COMPOSE]"
          docker-compose \
            -f db-compose.yml \
            -f keycloak-compose.yml \
            -f nginx-compose.yml \
            -f backend-compose.yml up -d

          docker-compose -f frontend-compose.yml up -d

          EOF
